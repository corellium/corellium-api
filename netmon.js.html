<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>netmon.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Agent.html">Agent</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Agent.html#appList">appList</a></li><li data-type='method' style='display: none;'><a href="Agent.html#changeFileAttributes">changeFileAttributes</a></li><li data-type='method' style='display: none;'><a href="Agent.html#connectToWifi">connectToWifi</a></li><li data-type='method' style='display: none;'><a href="Agent.html#crashes">crashes</a></li><li data-type='method' style='display: none;'><a href="Agent.html#deleteFile">deleteFile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#disableSSLPinning">disableSSLPinning</a></li><li data-type='method' style='display: none;'><a href="Agent.html#disableUIAutomation">disableUIAutomation</a></li><li data-type='method' style='display: none;'><a href="Agent.html#disconnect">disconnect</a></li><li data-type='method' style='display: none;'><a href="Agent.html#disconnectFromWifi">disconnectFromWifi</a></li><li data-type='method' style='display: none;'><a href="Agent.html#download">download</a></li><li data-type='method' style='display: none;'><a href="Agent.html#enableSSLPinning">enableSSLPinning</a></li><li data-type='method' style='display: none;'><a href="Agent.html#enableUIAutomation">enableUIAutomation</a></li><li data-type='method' style='display: none;'><a href="Agent.html#getProfile">getProfile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#getProp">getProp</a></li><li data-type='method' style='display: none;'><a href="Agent.html#install">install</a></li><li data-type='method' style='display: none;'><a href="Agent.html#installFile">installFile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#installProfile">installProfile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#installProvisioningProfile">installProvisioningProfile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#isSSLPinningEnabled">isSSLPinningEnabled</a></li><li data-type='method' style='display: none;'><a href="Agent.html#kill">kill</a></li><li data-type='method' style='display: none;'><a href="Agent.html#listProvisioningProfiles">listProvisioningProfiles</a></li><li data-type='method' style='display: none;'><a href="Agent.html#lockDevice">lockDevice</a></li><li data-type='method' style='display: none;'><a href="Agent.html#network">network</a></li><li data-type='method' style='display: none;'><a href="Agent.html#preApproveProvisioningProfile">preApproveProvisioningProfile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#profileList">profileList</a></li><li data-type='method' style='display: none;'><a href="Agent.html#ready">ready</a></li><li data-type='method' style='display: none;'><a href="Agent.html#removeProfile">removeProfile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#removeProvisioningProfile">removeProvisioningProfile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#run">run</a></li><li data-type='method' style='display: none;'><a href="Agent.html#runActivity">runActivity</a></li><li data-type='method' style='display: none;'><a href="Agent.html#runFrida">runFrida</a></li><li data-type='method' style='display: none;'><a href="Agent.html#runFridaKill">runFridaKill</a></li><li data-type='method' style='display: none;'><a href="Agent.html#runFridaPs">runFridaPs</a></li><li data-type='method' style='display: none;'><a href="Agent.html#shellExec">shellExec</a></li><li data-type='method' style='display: none;'><a href="Agent.html#shutdown">shutdown</a></li><li data-type='method' style='display: none;'><a href="Agent.html#stat">stat</a></li><li data-type='method' style='display: none;'><a href="Agent.html#tempFile">tempFile</a></li><li data-type='method' style='display: none;'><a href="Agent.html#uninstall">uninstall</a></li><li data-type='method' style='display: none;'><a href="Agent.html#unlockDevice">unlockDevice</a></li><li data-type='method' style='display: none;'><a href="Agent.html#upload">upload</a></li></ul></li><li><a href="Corellium.html">Corellium</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Corellium.html#addProjectKey">addProjectKey</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#createProject">createProject</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#createRole">createRole</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#deleteProjectKey">deleteProjectKey</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#destroyRole">destroyRole</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#destroyUser">destroyUser</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#getProject">getProject</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#getTeam">getTeam</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#getTeamsAndUsers">getTeamsAndUsers</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#getUser">getUser</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#login">login</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#projectKeys">projectKeys</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#projectNamed">projectNamed</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#projects">projects</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#roles">roles</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#supported">supported</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#teams">teams</a></li><li data-type='method' style='display: none;'><a href="Corellium.html#users">users</a></li></ul></li><li><a href="Input.html">Input</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Input.html#delay">delay</a></li><li data-type='method' style='display: none;'><a href="Input.html#press">press</a></li><li data-type='method' style='display: none;'><a href="Input.html#pressRelease">pressRelease</a></li><li data-type='method' style='display: none;'><a href="Input.html#release">release</a></li><li data-type='method' style='display: none;'><a href="Input.html#swipeTo">swipeTo</a></li><li data-type='method' style='display: none;'><a href="Input.html#tap">tap</a></li><li data-type='method' style='display: none;'><a href="Input.html#touch">touch</a></li><li data-type='method' style='display: none;'><a href="Input.html#touchUp">touchUp</a></li></ul></li><li><a href="Instance.html">Instance</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Instance.html#agent">agent</a></li><li data-type='method' style='display: none;'><a href="Instance.html#clearCoreTraceFilter">clearCoreTraceFilter</a></li><li data-type='method' style='display: none;'><a href="Instance.html#clearCoreTraceLog">clearCoreTraceLog</a></li><li data-type='method' style='display: none;'><a href="Instance.html#clearPanics">clearPanics</a></li><li data-type='method' style='display: none;'><a href="Instance.html#console">console</a></li><li data-type='method' style='display: none;'><a href="Instance.html#consoleLog">consoleLog</a></li><li data-type='method' style='display: none;'><a href="Instance.html#destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="Instance.html#disableExposedPort">disableExposedPort</a></li><li data-type='method' style='display: none;'><a href="Instance.html#downloadCoreTraceLog">downloadCoreTraceLog</a></li><li data-type='method' style='display: none;'><a href="Instance.html#enableExposedPort">enableExposedPort</a></li><li data-type='method' style='display: none;'><a href="Instance.html#executeFridaScript">executeFridaScript</a></li><li data-type='method' style='display: none;'><a href="Instance.html#finishRestore">finishRestore</a></li><li data-type='method' style='display: none;'><a href="Instance.html#fridaConsole">fridaConsole</a></li><li data-type='method' style='display: none;'><a href="Instance.html#getCoreTraceThreadList">getCoreTraceThreadList</a></li><li data-type='method' style='display: none;'><a href="Instance.html#getPeripherals">getPeripherals</a></li><li data-type='method' style='display: none;'><a href="Instance.html#modifyBootOptions">modifyBootOptions</a></li><li data-type='method' style='display: none;'><a href="Instance.html#modifyPeripherals">modifyPeripherals</a></li><li data-type='method' style='display: none;'><a href="Instance.html#networkMonitor">networkMonitor</a></li><li data-type='method' style='display: none;'><a href="Instance.html#newAgent">newAgent</a></li><li data-type='method' style='display: none;'><a href="Instance.html#newNetworkMonitor">newNetworkMonitor</a></li><li data-type='method' style='display: none;'><a href="Instance.html#panics">panics</a></li><li data-type='method' style='display: none;'><a href="Instance.html#pause">pause</a></li><li data-type='method' style='display: none;'><a href="Instance.html#rate">rate</a></li><li data-type='method' style='display: none;'><a href="Instance.html#reboot">reboot</a></li><li data-type='method' style='display: none;'><a href="Instance.html#rename">rename</a></li><li data-type='method' style='display: none;'><a href="Instance.html#sendInput">sendInput</a></li><li data-type='method' style='display: none;'><a href="Instance.html#setCoreTraceFilter">setCoreTraceFilter</a></li><li data-type='method' style='display: none;'><a href="Instance.html#snapshots">snapshots</a></li><li data-type='method' style='display: none;'><a href="Instance.html#start">start</a></li><li data-type='method' style='display: none;'><a href="Instance.html#startCoreTrace">startCoreTrace</a></li><li data-type='method' style='display: none;'><a href="Instance.html#stop">stop</a></li><li data-type='method' style='display: none;'><a href="Instance.html#stopCoreTrace">stopCoreTrace</a></li><li data-type='method' style='display: none;'><a href="Instance.html#takeScreenshot">takeScreenshot</a></li><li data-type='method' style='display: none;'><a href="Instance.html#takeSnapshot">takeSnapshot</a></li><li data-type='method' style='display: none;'><a href="Instance.html#unpause">unpause</a></li><li data-type='method' style='display: none;'><a href="Instance.html#waitForState">waitForState</a></li></ul></li><li><a href="NetworkMonitor.html">NetworkMonitor</a><ul class='methods'><li data-type='method' style='display: none;'><a href="NetworkMonitor.html#clearLog">clearLog</a></li><li data-type='method' style='display: none;'><a href="NetworkMonitor.html#disconnect">disconnect</a></li><li data-type='method' style='display: none;'><a href="NetworkMonitor.html#handleMessage">handleMessage</a></li><li data-type='method' style='display: none;'><a href="NetworkMonitor.html#isEnabled">isEnabled</a></li><li data-type='method' style='display: none;'><a href="NetworkMonitor.html#start">start</a></li><li data-type='method' style='display: none;'><a href="NetworkMonitor.html#stop">stop</a></li></ul></li><li><a href="Project.html">Project</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Project.html#addKey">addKey</a></li><li data-type='method' style='display: none;'><a href="Project.html#createInstance">createInstance</a></li><li data-type='method' style='display: none;'><a href="Project.html#createRole">createRole</a></li><li data-type='method' style='display: none;'><a href="Project.html#deleteKey">deleteKey</a></li><li data-type='method' style='display: none;'><a href="Project.html#destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="Project.html#getInstance">getInstance</a></li><li data-type='method' style='display: none;'><a href="Project.html#getToken">getToken</a></li><li data-type='method' style='display: none;'><a href="Project.html#instances">instances</a></li><li data-type='method' style='display: none;'><a href="Project.html#keys">keys</a></li><li data-type='method' style='display: none;'><a href="Project.html#refresh">refresh</a></li><li data-type='method' style='display: none;'><a href="Project.html#roles">roles</a></li><li data-type='method' style='display: none;'><a href="Project.html#setQuotas">setQuotas</a></li><li data-type='method' style='display: none;'><a href="Project.html#uploadImage">uploadImage</a></li><li data-type='method' style='display: none;'><a href="Project.html#uploadIotFirmware">uploadIotFirmware</a></li><li data-type='method' style='display: none;'><a href="Project.html#uploadKernel">uploadKernel</a></li><li data-type='method' style='display: none;'><a href="Project.html#vpnConfig">vpnConfig</a></li></ul></li><li><a href="Role.html">Role</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Role.html#destroy">destroy</a></li></ul></li><li><a href="Snapshot.html">Snapshot</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Snapshot.html#delete">delete</a></li><li data-type='method' style='display: none;'><a href="Snapshot.html#rename">rename</a></li><li data-type='method' style='display: none;'><a href="Snapshot.html#restore">restore</a></li></ul></li><li><a href="Team.html">Team</a></li><li><a href="User.html">User</a><ul class='methods'><li data-type='method' style='display: none;'><a href="User.html#destroy">destroy</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Instance.html#event:change">change</a></li><li><a href="Instance.html#event:panic">panic</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AppListEntry">AppListEntry</a></li><li><a href="global.html#CommandResult">CommandResult</a></li><li><a href="global.html#FirmwareImage">FirmwareImage</a></li><li><a href="global.html#FridaPsResult">FridaPsResult</a></li><li><a href="global.html#I">I</a></li><li><a href="global.html#KernelImage">KernelImage</a></li><li><a href="global.html#NetmonEntry">NetmonEntry</a></li><li><a href="global.html#PanicInfo">PanicInfo</a></li><li><a href="global.html#PeripheralData">PeripheralData</a></li><li><a href="global.html#ProjectImage">ProjectImage</a></li><li><a href="global.html#ProjectKey">ProjectKey</a></li><li><a href="global.html#ProjectQuotas">ProjectQuotas</a></li><li><a href="global.html#ProvisioningProfileInfo">ProvisioningProfileInfo</a></li><li><a href="global.html#RateInfo">RateInfo</a></li><li><a href="global.html#ShellExecResult">ShellExecResult</a></li><li><a href="global.html#StatEntry">StatEntry</a></li><li><a href="global.html#SupportedDevice">SupportedDevice</a></li><li><a href="global.html#ThreadInfo">ThreadInfo</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">netmon.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";

const WebSocket = require("ws");
const { fetchApi } = require("./util/fetch");

/**
 * @typedef {object} NetmonEntry
 * @property {Object} request
 * @property {Object} response
 * @property {integer} startedDateTime
 * @property {integer} duration
 */

/**
 * A connection to the network monitor running on an instance.
 *
 * Instances of this class
 * are returned from {@link Instance#networkMonitor} and {@link Instance#newNetworkMonitor}. They
 * should not be created using the constructor.
 * @hideconstructor
 */
class NetworkMonitor {
    constructor(instance) {
        this.instance = instance;
        this.connected = false;
        this.connectPromise = null;
        this.id = 0;
        this.handler = null;
        this._keepAliveTimeout = null;
        this._lastPong = null;
        this._lastPing = null;
    }

    /**
     * A callback for file upload progress messages. Can be passed to {@link NetworkMonitor#handleMessage}
     * @callback NetworkMonitor~newEntryCallback
     * @param {NetmonEntry} entry - {@link NetmonEntry} object.
     * @example
     * let netmon = await instance.newNetworkMonitor();
     * netmon.handleMessage((message) => {
     *     let host = message.request.headers.find(entry => entry.key === 'Host');
     *     console.log(message.response.status, message.request.method, message.response.body.size, host.value);
     * });
     */

    /**
     * Ensure the network monitor is connected.
     * @private
     */
    async connect() {
        this.pendingConnect = true;
        if (!this.connected) await this.reconnect();
    }

    /**
     * Ensure the network monitor is disconnected, then connect the network monitor.
     * @private
     */
    async reconnect() {
        if (this.connected) this.disconnect();

        if (this.connectPromise) return this.connectPromise;

        this.connectPromise = (async () => {
            while (this.pendingConnect) {
                try {
                    await this._connect();
                    break;
                } catch (e) {
                    await new Promise((resolve) => setTimeout(resolve, 1000));
                }
            }

            this.connectPromise = null;
        })();

        return this.connectPromise;
    }

    async _connect() {
        const endpoint = await this.instance.netmonEndpoint();

        // Detect if a disconnection happened before we were able to get the network monitor endpoint.
        if (!this.pendingConnect) throw new Error("connection cancelled");

        let ws = new WebSocket(endpoint);

        this.ws = ws;

        ws.on("message", (data) => {
            try {
                let message;
                if (typeof data === "string") {
                    message = JSON.parse(data);
                } else if (data.length >= 8) {
                    message = data.slice(8);
                }

                if (this.handler) {
                    this.handler(message);
                }
            } catch (err) {
                console.error("error in agent message handler", err);
            }
        });

        ws.on("close", () => {
            this._disconnect();
        });

        await new Promise((resolve, reject) => {
            ws.once("open", () => {
                if (this.ws !== ws) {
                    try {
                        ws.close();
                    } catch (e) {
                        // Swallow ws.close() errors.
                    }

                    reject(new Error("connection cancelled"));
                    return;
                }

                ws.on("error", (err) => {
                    if (this.ws === ws) {
                        this._disconnect();
                    } else {
                        try {
                            ws.close();
                        } catch (e) {
                            // Swallow ws.close() errors.
                        }
                    }

                    console.error("error in netmon socket", err);
                });

                resolve();
            });

            ws.once("error", (err) => {
                if (this.ws === ws) {
                    this._disconnect();
                } else {
                    try {
                        ws.close();
                    } catch (e) {
                        // Swallow ws.close() errors.
                    }
                }

                reject(err);
            });
        });

        this.connected = true;
        this._startKeepAlive();
    }

    _startKeepAlive() {
        if (!this.connected) return;

        let ws = this.ws;

        ws.ping();

        this._keepAliveTimeout = setTimeout(() => {
            if (this.ws !== ws) {
                try {
                    ws.close();
                } catch (e) {
                    // Swallow ws.close() errors.
                }
                return;
            }

            console.error("Netmon did not get a response to pong in 10 seconds, disconnecting.");

            this._disconnect();
        }, 10000);

        ws.once("pong", async () => {
            if (ws !== this.ws) return;

            clearTimeout(this._keepAliveTimeout);
            this._keepAliveTimeout = null;

            await new Promise((resolve) => setTimeout(resolve, 10000));

            this._startKeepAlive();
        });
    }

    _stopKeepAlive() {
        if (this._keepAliveTimeout) {
            clearTimeout(this._keepAliveTimeout);
            this._keepAliveTimeout = null;
        }
    }

    /**
     * Disconnect an network monitor connection. This is usually only required if a new
     * network monitor connection has been created and is no longer needed
     * @example
     * netmon.disconnect();
     */
    disconnect() {
        this.pendingConnect = false;
        this._disconnect();
    }

    _disconnect() {
        this.connected = false;
        this.handler = null;
        this._stopKeepAlive();
        if (this.ws) {
            try {
                this.ws.close();
            } catch (e) {
                // Swallow ws.close() errors.
            }
            this.ws = null;
        }
    }

    /** Start Network Monitor
     * @example
     * let netmon = await instance.newNetworkMonitor();
     * netmon.start();
     */
    async start() {
        await this.connect();
        await this._fetch("/sslsplit/enable", { method: "POST" });
        while (!(await this.isEnabled()));

        return true;
    }

    /** Set message handler
     * @param {NetworkMonitor~newEntryCallback} handler - the callback for captured entry
     * @example
     * let netmon = await instance.newNetworkMonitor();
     * netmon.handleMessage((message) => {
     *     let host = message.request.headers.find(entry => entry.key === 'Host');
     *     console.log(message.response.status, message.request.method, message.response.body.size, host.value);
     * });
     */
    async handleMessage(handler) {
        this.handler = handler;
    }

    /** Clear captured Network Monitor data
     * @example
     * let netmon = await instance.newNetworkMonitor();
     * netmon.clearLog();
     */
    async clearLog() {
        let disconnectAfter = false;
        if (!this.connected) {
            await this.connect();
            disconnectAfter = true;
        }
        await this.ws.send(JSON.stringify({ type: "clear" }));
        if (disconnectAfter) {
            await this.disconnect();
        }
    }

    /** Stop Network Monitor
     * @example
     * let netmon = await instance.newNetworkMonitor();
     * netmon.stop();
     */
    async stop() {
        await this._fetch("/sslsplit/disable", { method: "POST" });
        await this.disconnect();
        return (await this.isEnabled()) === false;
    }

    /** Check if Network Monitor is enabled
     * @returns {boolean}
     * @example
     * let enabled = await netmon.isEnabled();
     * if (enabled) {
     *     console.log("enabled");
     * } else {
     *     console.log("disabled");
     * }
     */
    async isEnabled() {
        let info = await fetchApi(this.instance.project, `/instances/${this.instance.id}`);
        return info ? (info.netmon ? info.netmon.enabled : false) : false;
    }

    async _fetch(endpoint = "", options = {}) {
        return await fetchApi(
            this.instance.project,
            `/instances/${this.instance.id}${endpoint}`,
            options,
        );
    }
}

module.exports = NetworkMonitor;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Thu Sep 16 2021 17:29:30 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
